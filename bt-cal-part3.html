// calendar from http://www.codemiles.com/javascript-examples/simple-javascript-calendar-t7767.html
//not sure why formating is off...
// https://github.com/PolymerElements/paper-material will need this for other elements

<link rel="import" href="../polymer/polymer.html">

<dom-module id="bt-cal">
	<style>
		#dayNames th {
			width:100px;
		}
		#week{
			height:80px;
		}
		#date{
			text-align: right;
  			vertical-align: -webkit-baseline-middle;
		}
		table,td{
			border: 1px solid black;
		}
	</style>
	<template>
		<table class='calendar'>
			<tr class='monthNow'>
				<th colspan='7'>
					<span>{{month}}</span>
				</th>
				</tr>
				<tr id='dayNames'>  
					<th>Sun</th>  
					<th>Mon</th> 
					<th>Tues</th>
					<th>Wed</th> 
					<th>Thurs</th> 
					<th>Fri</th> 
					<th>Sat</th> 
				</tr>
			<template is="dom-repeat" items="{{calendar}}" as="week">
				<tr id='week'>
					<template is="dom-repeat" items="{{week}}" as="i">
						<td id='date'>{{i.day}}</td>
					</template>	
				</tr>
			</template>
		</table>
	</template>
</dom-module>

<script>
	Polymer({
		is:'bt-cal',
		properties:{
		},
		ready: function(){
			this.calendar = this._buildCalendar(this.date);
			this.month = this._getMonth(this.date);
		},
		_buildCalendar: function(date){
			var date = date || new Date(); //if date is passed use otherwise use today's date.

			//Get the array of dates.
			return this._recurseWeeks(this._getFirstSunday(date), this._lastDayInMonth(date))
		},
		_getMonth: function(date){
			var months = ["January","February","March","April","May","June","July","August","September","October","November", "December"];
			return months[date.getMonth()];
		},
	
		//Recursive function that builds the month array week by week by passing each Sunday.
	 	_recurseWeeks: function(thisSun, monthEnd, monthArr){
			var monthArr = monthArr || new Array;
			if (thisSun.getTime()<=monthEnd.getTime()){
				monthArr.push(this._getWeekArray(thisSun,monthEnd));
				this._recurseWeeks(new Date(thisSun.getTime()+604800000), monthEnd, monthArr);
			}
			return monthArr;
		},

		// Builds an array for any week week starting on the Sunday and recurse through each day.
		_getWeekArray: function(dayOfWeek, monthEnd){
			var weekArr = new Array;
			for (var i=0; i<7; i++){
			 	weekArr.push({date:dayOfWeek.toJSON(), day:dayOfWeek.getDate()});
				dayOfWeek = new Date(dayOfWeek.getTime()+86400000);
			}
			return weekArr;
		},

		//helper function to find the day of the week to start the month
		_getFirstSunday: function(date){
			var dateOfFirst = new Date(date.getFullYear(), date.getMonth(), 1);
			return new Date (dateOfFirst.getTime() - (dateOfFirst.getDay())*86400000);
		},

		//helper function that returns the last day of the given month by first finding the number of "days" in the given month.
		_lastDayInMonth: function(date) {
			var days;
			switch(date.getMonth()){
				case 0: days = 31;break; //Jan
				case 1:
					if ( (date.getYear()%100!=0) && (date.getYear()%4==0) || (date.getYear()%400==0)){
					  days = 29;break;
					}else{
					  days = 28;break;
					} //Feb
				case 2: days = 31;break; //March
				case 3: days = 30;break; //April
				case 4: days = 31;break; //May
				case 5: days = 30;break; //June
				case 6: days = 31;break; //July
				case 7: days = 31;break; //Aug
				case 8: days = 30;break; //Sep
				case 9: days = 31;break; //Oct
				case 10: days = 30;break; //Nov
				case 11: days = 31;break; //Dec
			}
			var dateOfFirst = new Date(date.getFullYear(), date.getMonth(), 1);
			return new Date (dateOfFirst.getTime() + (days-1)*1000*60*60*24);
		}
	});
	
</script>